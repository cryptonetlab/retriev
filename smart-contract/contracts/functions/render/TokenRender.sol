// SPDX-License-Identifier: MIT
pragma solidity ^0.8.6;

import "./Base64.sol";
import "@openzeppelin/contracts/utils/Strings.sol";

contract TokenRender {
    struct Deal {
        // subject of the deal
        string data_uri;
        // Timestamp request
        uint256 timestamp_request;
        // Starting timestamp
        uint256 timestamp_start;
        // Duration of deal expressed in seconds
        uint256 duration;
        // Amount in wei paid for the deal
        uint256 value;
        // Amount in wei needed to accept the deal
        uint256 collateral;
        // Address of provider
        mapping(address => bool) providers;
        // Address of owner
        address owner;
        // Describe if deal is active or not
        bool active;
        // Describe if deal is canceled or not
        bool canceled;
    }

    function contains(string memory what, string memory where)
        public
        pure
        returns (bool)
    {
        bytes memory whatBytes = bytes(what);
        bytes memory whereBytes = bytes(where);

        require(whereBytes.length >= whatBytes.length);

        bool found = false;
        for (uint256 i = 0; i <= whereBytes.length - whatBytes.length; i++) {
            bool flag = true;
            for (uint256 j = 0; j < whatBytes.length; j++)
                if (whereBytes[i + j] != whatBytes[j]) {
                    flag = false;
                    break;
                }
            if (flag) {
                found = true;
                break;
            }
        }
        return found;
    }

    function render(
        uint256 deal_index,
        string memory data_uri,
        uint256 value,
        uint256 timestamp_start,
        uint256 duration,
        bool canceled
    ) external pure returns (string memory) {
        if (contains("ipfs://", data_uri)) {
            string[12] memory parts;
            parts[
                0
            ] = '<svg width="1053" height="1053" viewBox="0 0 1053 1053" fill="none" xmlns="http://www.w3.org/2000/svg"><style>.base { fill: #000; font-family: monospace; font-size: 16px; }</style><g clip-path="url(#clip0_38_48)"><rect width="1053" height="1053" fill="#2D2C2C"/><rect width="1600" height="1092" transform="translate(-37 -12)" fill="url(#paint0_linear_38_48)"/><g clip-path="url(#clip1_38_48)"><path d="M71.9707 102.63V74.4H84.6007C86.9905 74.3441 89.3683 74.7551 91.6007 75.61C93.401 76.3089 94.9605 77.5141 96.0907 79.08C97.164 80.6579 97.7165 82.5322 97.6707 84.44C97.724 86.3457 97.1707 88.2191 96.0907 89.79C94.9549 91.3412 93.396 92.5321 91.6007 93.22C89.3656 94.063 86.9888 94.467 84.6007 94.41H75.1307L77.6707 92.03V102.63H71.9707ZM77.6707 92.63L75.1307 90.13H84.3307C86.3364 90.2724 88.3331 89.7486 90.0107 88.64C90.6373 88.1488 91.1375 87.515 91.4697 86.7914C91.8019 86.0679 91.9566 85.2754 91.9207 84.48C91.9625 83.6853 91.8105 82.8923 91.4778 82.1694C91.1451 81.4464 90.6415 80.8152 90.0107 80.33C88.324 79.245 86.331 78.7362 84.3307 78.88H75.1307L77.6707 76.3V92.63ZM92.0507 102.63L84.2907 92.39H90.3807L98.1907 102.63H92.0507Z" fill="#161616"/><path d="M109.741 98.24H127.061V102.63H104.061V74.4H126.461V78.8H109.741V98.24ZM109.311 86.14H124.561V90.45H109.311V86.14Z" fill="#161616"/><path d="M139.641 102.63V78.84H129.471V74.4H155.471V78.84H145.341V102.63H139.641Z" fill="#161616"/><path d="M159.811 102.63V74.4H172.431C174.821 74.3422 177.199 74.7533 179.431 75.61C181.233 76.3107 182.795 77.5153 183.931 79.08C185.001 80.6588 185.55 82.5331 185.501 84.4399C185.557 86.3445 185.007 88.2178 183.931 89.79C182.792 91.3427 181.229 92.5337 179.431 93.22C177.196 94.0647 174.819 94.4688 172.431 94.41H162.971L165.51 92.03V102.63H159.811ZM165.501 92.6299L162.961 90.1299H172.171C174.173 90.2708 176.166 89.7471 177.841 88.64C178.467 88.1487 178.967 87.515 179.3 86.7914C179.632 86.0678 179.786 85.2754 179.751 84.48C179.794 83.685 179.643 82.8914 179.31 82.1682C178.977 81.445 178.473 80.8139 177.841 80.33C176.157 79.2464 174.168 78.7376 172.171 78.8799H162.971L165.51 76.3L165.501 92.6299ZM179.88 102.63L172.121 92.39H178.221L186.021 102.63H179.88Z" fill="#161616"/><path d="M191.85 102.63V74.4H197.55V102.63H191.85Z" fill="#161616"/><path d="M211.53 98.24H228.85V102.63H205.85V74.4H228.25V78.8H211.55L211.53 98.24ZM211.09 86.14H226.35V90.45H211.09V86.14Z" fill="#161616"/><path d="M243.84 102.63L230.42 74.4H236.61L248.61 99.93H245.06L257.16 74.4H262.86L249.49 102.63H243.84Z" fill="#161616"/><path d="M266.33 102.92C265.39 102.939 264.479 102.599 263.78 101.97C263.449 101.667 263.188 101.295 263.016 100.88C262.843 100.466 262.763 100.019 262.78 99.57C262.755 99.1144 262.831 98.6589 263.004 98.2367C263.177 97.8145 263.442 97.4364 263.78 97.13C264.497 96.5391 265.397 96.2159 266.325 96.2159C267.254 96.2159 268.154 96.5391 268.87 97.13C269.217 97.4316 269.492 97.8077 269.674 98.2301C269.856 98.6526 269.94 99.1105 269.92 99.57C269.932 100.023 269.844 100.472 269.662 100.887C269.481 101.301 269.21 101.671 268.87 101.97C268.176 102.599 267.267 102.939 266.33 102.92Z" fill="#161616"/><path d="M289.301 103.04C287.048 103.061 284.808 102.693 282.681 101.95C280.754 101.29 278.97 100.272 277.421 98.95C275.93 97.6611 274.735 96.0665 273.915 94.2746C273.096 92.4826 272.672 90.5353 272.672 88.565C272.672 86.5946 273.096 84.6473 273.915 82.8554C274.735 81.0634 275.93 79.4689 277.421 78.18C278.969 76.8577 280.754 75.8399 282.681 75.18C286.95 73.727 291.581 73.727 295.851 75.18C297.769 75.8445 299.546 76.862 301.091 78.18C302.553 79.4541 303.732 81.0213 304.551 82.78C305.383 84.5957 305.803 86.5729 305.781 88.57C305.799 90.5732 305.379 92.5562 304.551 94.38C303.74 96.1403 302.56 97.7057 301.091 98.97C299.542 100.281 297.766 101.298 295.851 101.97C293.746 102.704 291.529 103.066 289.301 103.04V103.04ZM289.251 98.44C290.716 98.4558 292.172 98.2086 293.551 97.71C294.801 97.2689 295.949 96.5789 296.925 95.6817C297.901 94.7845 298.686 93.6988 299.231 92.49C299.765 91.2348 300.041 89.8844 300.041 88.52C300.041 87.1556 299.765 85.8053 299.231 84.55C298.69 83.3626 297.922 82.2925 296.971 81.4C295.979 80.4882 294.816 79.7813 293.551 79.32C292.171 78.8295 290.715 78.5858 289.251 78.6C287.796 78.5841 286.35 78.8279 284.981 79.32C283.717 79.786 282.556 80.4923 281.561 81.4C280.582 82.3097 279.801 83.4115 279.267 84.6366C278.733 85.8616 278.457 87.1836 278.457 88.52C278.457 89.8563 278.733 91.1783 279.267 92.4034C279.801 93.6285 280.582 94.7302 281.561 95.64C282.547 96.5563 283.711 97.2607 284.981 97.71C286.349 98.2071 287.795 98.4544 289.251 98.44V98.44Z" fill="#161616"/><path d="M311.83 102.63V74.4H324.45C326.84 74.3445 329.218 74.7556 331.45 75.61C333.25 76.3089 334.81 77.514 335.94 79.08C337.013 80.6579 337.566 82.5322 337.52 84.44C337.573 86.3456 337.02 88.219 335.94 89.79C334.804 91.3412 333.245 92.5321 331.45 93.22C329.215 94.0625 326.838 94.4665 324.45 94.41H314.97L317.51 92.03V102.63H311.83ZM317.53 92.63L314.99 90.13H324.19C326.196 90.2708 328.192 89.7472 329.87 88.64C330.495 88.1477 330.993 87.5135 331.324 86.79C331.654 86.0664 331.807 85.2746 331.77 84.48C331.814 83.686 331.664 82.8933 331.333 82.1703C331.002 81.4472 330.5 80.8156 329.87 80.33C328.183 79.2463 326.19 78.7376 324.19 78.88H314.97L317.51 76.3L317.53 92.63ZM331.91 102.63L324.15 92.39H330.24L338.04 102.63H331.91Z" fill="#161616"/><path d="M358.21 103.04C355.965 103.064 353.732 102.702 351.61 101.97C349.688 101.314 347.909 100.295 346.37 98.97C344.878 97.6736 343.681 96.0721 342.861 94.2736C342.041 92.4751 341.617 90.5216 341.617 88.545C341.617 86.5684 342.041 84.6149 342.861 82.8164C343.681 81.0179 344.878 79.4163 346.37 78.1199C347.929 76.7969 349.724 75.7792 351.66 75.1199C353.789 74.3889 356.028 74.0271 358.28 74.05C360.664 74.0196 363.035 74.4158 365.28 75.22C367.281 75.9405 369.088 77.1145 370.56 78.65L366.97 81.8699C365.844 80.8168 364.527 79.9887 363.09 79.43C361.622 78.8971 360.071 78.6329 358.51 78.65C356.99 78.6353 355.478 78.8787 354.04 79.3699C352.732 79.8154 351.526 80.5156 350.49 81.43C349.503 82.3021 348.715 83.3764 348.18 84.58C347.645 85.8352 347.37 87.1856 347.37 88.55C347.37 89.9144 347.645 91.2647 348.18 92.52C348.717 93.7279 349.505 94.8083 350.49 95.69C351.508 96.6055 352.697 97.3092 353.99 97.76C355.426 98.263 356.939 98.5101 358.46 98.49C359.956 98.4953 361.443 98.2693 362.87 97.82C364.333 97.3376 365.69 96.5807 366.87 95.59L370.12 99.5C368.43 100.718 366.537 101.625 364.53 102.18C362.472 102.753 360.346 103.042 358.21 103.04V103.04ZM364.83 98.76V88.15H370.22V99.45L364.83 98.76Z" fill="#161616"/></g><rect width="1600" height="1092" transform="translate(-37 -12)" fill="url(#paint1_linear_38_48)"/><g clip-path="url(#clip2_38_48)"><path d="M574.182 263.05L670.217 353.481L669.892 528.926L601.868 538.576L602.141 387.367L551.563 339.736L343.724 368.928L343.21 648.244L442.875 634.226L442.739 707.73L275.049 731.283L275.836 305.021L574.182 263.05Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M681.905 321.675L777.93 412.106L777.605 587.551L709.581 597.211L709.864 446.002L659.307 398.329L451.468 427.595L450.943 706.911L550.609 692.893L550.472 766.397L382.793 790.002L383.58 363.677L681.905 321.675Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M681.905 321.675L777.93 412.106L777.605 587.551L709.581 597.211L709.864 446.002L659.307 398.329L451.468 427.595L450.943 706.911L550.609 692.893L550.472 766.397L382.793 790.002L383.58 363.677L681.905 321.675Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M777.951 412.148L777.626 587.582L669.893 528.926L670.218 353.481L777.951 412.148Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M777.951 412.148L777.626 587.582L669.893 528.926L670.218 353.481L777.951 412.148Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M777.625 587.582L709.6 597.243L601.867 538.586L669.892 528.926L777.625 587.582Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M777.625 587.582L709.6 597.243L601.867 538.586L669.892 528.926L777.625 587.582Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M709.6 597.243L601.867 538.586L602.15 387.325L709.884 445.992L709.6 597.243Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M709.6 597.243L601.867 538.586L602.15 387.325L709.884 445.992L709.6 597.243Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M602.15 387.325L552.076 339.978L659.306 398.361L451.466 427.595L343.723 368.938" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M659.306 398.361L451.466 427.595L343.723 368.938L551.562 339.694L659.306 398.361Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M451.467 427.595L450.942 706.88L343.209 648.213L343.723 368.938L451.467 427.595Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M451.467 427.595L450.942 706.88L343.209 648.213L343.723 368.938L451.467 427.595Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M450.942 706.88L343.209 648.213L442.864 634.194L550.608 692.861L450.942 706.88Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M450.942 706.88L343.209 648.213L442.864 634.194L550.608 692.861L450.942 706.88Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M550.609 692.861L550.472 766.366L442.729 707.699L442.865 634.194L550.609 692.861Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M550.609 692.861L550.472 766.366L442.729 707.699L442.865 634.194L550.609 692.861Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M550.472 766.366L382.793 789.95L275.049 731.293L442.728 707.699L550.472 766.366Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M550.472 766.366L382.793 789.95L275.049 731.293L442.728 707.699L550.472 766.366Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M382.793 789.95L275.049 731.294L275.836 305.021L383.579 363.677L382.793 789.95Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M382.793 789.95L275.049 731.294L275.836 305.021L383.579 363.677L382.793 789.95Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M383.066 363.404L275.836 305.021L574.182 263.05L681.926 321.717" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M275.836 305.021L574.182 263.05L681.926 321.717" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M601.868 538.513L601.596 685.679L533.708 695.224L533.844 621.405L442.865 634.194L443.023 560.858L601.868 538.513Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M601.868 538.513L601.596 685.679L533.708 695.224L533.844 621.405L442.865 634.194L443.023 560.858L601.868 538.513Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M709.6 597.169L709.327 744.346L641.439 753.891L641.576 680.061L550.607 692.861L550.754 619.514L709.6 597.169Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M709.6 597.169L709.327 744.346L641.439 753.891L641.576 680.061L550.607 692.861L550.754 619.514L709.6 597.169Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M709.602 597.169L709.329 744.346L601.596 685.679L601.868 538.513L709.602 597.169Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M709.602 597.169L709.329 744.346L601.596 685.679L601.868 538.513L709.602 597.169Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M709.328 744.346L641.44 753.891L533.707 695.224L601.595 685.679L709.328 744.346Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M709.328 744.346L641.44 753.891L533.707 695.224L601.595 685.679L709.328 744.346Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M641.44 753.891L533.707 695.224L533.843 621.405L641.577 680.061L641.44 753.891Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M641.44 753.891L533.707 695.224L533.843 621.405L641.577 680.061L641.44 753.891Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M641.577 680.061L550.609 692.861L442.865 634.194L533.844 621.405L641.577 680.061Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M641.577 680.061L550.609 692.861L442.865 634.194L533.844 621.405L641.577 680.061Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M550.609 692.861L442.865 634.194L443.023 560.858L550.756 619.514L550.609 692.861Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M550.609 692.861L442.865 634.194L443.023 560.858L550.756 619.514L550.609 692.861Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M550.755 619.514L443.021 560.858L601.867 538.513L709.601 597.169L550.755 619.514Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M550.755 619.514L443.021 560.858L601.867 538.513L709.601 597.169L550.755 619.514Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M343.725 368.938L383.58 363.803" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M574.182 263.05L670.217 353.481" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></g><g clip-path="url(#clip3_38_48)"><path d="M71.9707 102.63V74.4H84.6007C86.9905 74.3441 89.3683 74.7551 91.6007 75.61C93.401 76.3089 94.9605 77.5141 96.0907 79.08C97.164 80.6579 97.7165 82.5322 97.6707 84.44C97.724 86.3457 97.1707 88.2191 96.0907 89.79C94.9549 91.3412 93.396 92.5321 91.6007 93.22C89.3656 94.063 86.9888 94.467 84.6007 94.41H75.1307L77.6707 92.03V102.63H71.9707ZM77.6707 92.63L75.1307 90.13H84.3307C86.3364 90.2724 88.3331 89.7486 90.0107 88.64C90.6373 88.1488 91.1375 87.515 91.4697 86.7914C91.8019 86.0679 91.9566 85.2754 91.9207 84.48C91.9625 83.6853 91.8105 82.8923 91.4778 82.1694C91.1451 81.4464 90.6415 80.8152 90.0107 80.33C88.324 79.245 86.331 78.7362 84.3307 78.88H75.1307L77.6707 76.3V92.63ZM92.0507 102.63L84.2907 92.39H90.3807L98.1907 102.63H92.0507Z" fill="#161616"/><path d="M109.741 98.24H127.061V102.63H104.061V74.4H126.461V78.8H109.741V98.24ZM109.311 86.14H124.561V90.45H109.311V86.14Z" fill="#161616"/><path d="M139.641 102.63V78.84H129.471V74.4H155.471V78.84H145.341V102.63H139.641Z" fill="#161616"/><path d="M159.811 102.63V74.4H172.431C174.821 74.3422 177.199 74.7533 179.431 75.61C181.233 76.3107 182.795 77.5153 183.931 79.08C185.001 80.6588 185.55 82.5331 185.501 84.4399C185.557 86.3445 185.007 88.2178 183.931 89.79C182.792 91.3427 181.229 92.5337 179.431 93.22C177.196 94.0647 174.819 94.4688 172.431 94.41H162.971L165.51 92.03V102.63H159.811ZM165.501 92.6299L162.961 90.1299H172.171C174.173 90.2708 176.166 89.7471 177.841 88.64C178.467 88.1487 178.967 87.515 179.3 86.7914C179.632 86.0678 179.786 85.2754 179.751 84.48C179.794 83.685 179.643 82.8914 179.31 82.1682C178.977 81.445 178.473 80.8139 177.841 80.33C176.157 79.2464 174.168 78.7376 172.171 78.8799H162.971L165.51 76.3L165.501 92.6299ZM179.88 102.63L172.121 92.39H178.221L186.021 102.63H179.88Z" fill="#161616"/><path d="M191.85 102.63V74.4H197.55V102.63H191.85Z" fill="#161616"/><path d="M211.53 98.24H228.85V102.63H205.85V74.4H228.25V78.8H211.55L211.53 98.24ZM211.09 86.14H226.35V90.45H211.09V86.14Z" fill="#161616"/><path d="M243.84 102.63L230.42 74.4H236.61L248.61 99.93H245.06L257.16 74.4H262.86L249.49 102.63H243.84Z" fill="#161616"/><path d="M266.33 102.92C265.39 102.939 264.479 102.599 263.78 101.97C263.449 101.667 263.188 101.295 263.016 100.88C262.843 100.466 262.763 100.019 262.78 99.57C262.755 99.1144 262.831 98.6589 263.004 98.2367C263.177 97.8145 263.442 97.4364 263.78 97.13C264.497 96.5391 265.397 96.2159 266.325 96.2159C267.254 96.2159 268.154 96.5391 268.87 97.13C269.217 97.4316 269.492 97.8077 269.674 98.2301C269.856 98.6526 269.94 99.1105 269.92 99.57C269.932 100.023 269.844 100.472 269.662 100.887C269.481 101.301 269.21 101.671 268.87 101.97C268.176 102.599 267.267 102.939 266.33 102.92Z" fill="#161616"/><path d="M289.301 103.04C287.048 103.061 284.808 102.693 282.681 101.95C280.754 101.29 278.97 100.272 277.421 98.95C275.93 97.6611 274.735 96.0665 273.915 94.2746C273.096 92.4826 272.672 90.5353 272.672 88.565C272.672 86.5946 273.096 84.6473 273.915 82.8554C274.735 81.0634 275.93 79.4689 277.421 78.18C278.969 76.8577 280.754 75.8399 282.681 75.18C286.95 73.727 291.581 73.727 295.851 75.18C297.769 75.8445 299.546 76.862 301.091 78.18C302.553 79.4541 303.732 81.0213 304.551 82.78C305.383 84.5957 305.803 86.5729 305.781 88.57C305.799 90.5732 305.379 92.5562 304.551 94.38C303.74 96.1403 302.56 97.7057 301.091 98.97C299.542 100.281 297.766 101.298 295.851 101.97C293.746 102.704 291.529 103.066 289.301 103.04V103.04ZM289.251 98.44C290.716 98.4558 292.172 98.2086 293.551 97.71C294.801 97.2689 295.949 96.5789 296.925 95.6817C297.901 94.7845 298.686 93.6988 299.231 92.49C299.765 91.2348 300.041 89.8844 300.041 88.52C300.041 87.1556 299.765 85.8053 299.231 84.55C298.69 83.3626 297.922 82.2925 296.971 81.4C295.979 80.4882 294.816 79.7813 293.551 79.32C292.171 78.8295 290.715 78.5858 289.251 78.6C287.796 78.5841 286.35 78.8279 284.981 79.32C283.717 79.786 282.556 80.4923 281.561 81.4C280.582 82.3097 279.801 83.4115 279.267 84.6366C278.733 85.8616 278.457 87.1836 278.457 88.52C278.457 89.8563 278.733 91.1783 279.267 92.4034C279.801 93.6285 280.582 94.7302 281.561 95.64C282.547 96.5563 283.711 97.2607 284.981 97.71C286.349 98.2071 287.795 98.4544 289.251 98.44V98.44Z" fill="#161616"/><path d="M311.83 102.63V74.4H324.45C326.84 74.3445 329.218 74.7556 331.45 75.61C333.25 76.3089 334.81 77.514 335.94 79.08C337.013 80.6579 337.566 82.5322 337.52 84.44C337.573 86.3456 337.02 88.219 335.94 89.79C334.804 91.3412 333.245 92.5321 331.45 93.22C329.215 94.0625 326.838 94.4665 324.45 94.41H314.97L317.51 92.03V102.63H311.83ZM317.53 92.63L314.99 90.13H324.19C326.196 90.2708 328.192 89.7472 329.87 88.64C330.495 88.1477 330.993 87.5135 331.324 86.79C331.654 86.0664 331.807 85.2746 331.77 84.48C331.814 83.686 331.664 82.8933 331.333 82.1703C331.002 81.4472 330.5 80.8156 329.87 80.33C328.183 79.2463 326.19 78.7376 324.19 78.88H314.97L317.51 76.3L317.53 92.63ZM331.91 102.63L324.15 92.39H330.24L338.04 102.63H331.91Z" fill="#161616"/><path d="M358.21 103.04C355.965 103.064 353.732 102.702 351.61 101.97C349.688 101.314 347.909 100.295 346.37 98.97C344.878 97.6736 343.681 96.0721 342.861 94.2736C342.041 92.4751 341.617 90.5216 341.617 88.545C341.617 86.5684 342.041 84.6149 342.861 82.8164C343.681 81.0179 344.878 79.4163 346.37 78.1199C347.929 76.7969 349.724 75.7792 351.66 75.1199C353.789 74.3889 356.028 74.0271 358.28 74.05C360.664 74.0196 363.035 74.4158 365.28 75.22C367.281 75.9405 369.088 77.1145 370.56 78.65L366.97 81.8699C365.844 80.8168 364.527 79.9887 363.09 79.43C361.622 78.8971 360.071 78.6329 358.51 78.65C356.99 78.6353 355.478 78.8787 354.04 79.3699C352.732 79.8154 351.526 80.5156 350.49 81.43C349.503 82.3021 348.715 83.3764 348.18 84.58C347.645 85.8352 347.37 87.1856 347.37 88.55C347.37 89.9144 347.645 91.2647 348.18 92.52C348.717 93.7279 349.505 94.8083 350.49 95.69C351.508 96.6055 352.697 97.3092 353.99 97.76C355.426 98.263 356.939 98.5101 358.46 98.49C359.956 98.4953 361.443 98.2693 362.87 97.82C364.333 97.3376 365.69 96.5807 366.87 95.59L370.12 99.5C368.43 100.718 366.537 101.625 364.53 102.18C362.472 102.753 360.346 103.042 358.21 103.04V103.04ZM364.83 98.76V88.15H370.22V99.45L364.83 98.76Z" fill="#161616"/></g></g><defs><linearGradient id="paint0_linear_38_48" x1="1688.5" y1="-256.074" x2="9.7741" y2="1096.51" gradientUnits="userSpaceOnUse"><stop stop-color="#33FF91"/><stop offset="0.760417" stop-color="#9A77FF"/></linearGradient><linearGradient id="paint1_linear_38_48" x1="1688.5" y1="-256.074" x2="9.7741" y2="1096.51" gradientUnits="userSpaceOnUse"><stop stop-color="#33FF91"/><stop offset="0.760417" stop-color="#9A77FF"/></linearGradient><clipPath id="clip0_38_48"><rect width="1053" height="1053" fill="white"/></clipPath><clipPath id="clip1_38_48"><rect width="298.61" height="29.04" fill="white" transform="translate(72 74)"/></clipPath><clipPath id="clip2_38_48"><rect width="505" height="529" fill="white" transform="translate(274 262)"/></clipPath><clipPath id="clip3_38_48"><rect width="298.61" height="29.04" fill="white" transform="translate(72 74)"/></clipPath></defs>';
            // TODO: Add logo here
            parts[1] = '<text x="10" y="890" class="base">URI: ';
            parts[2] = data_uri;
            parts[3] = '</text><text x="10" y="920" class="base">VALUE WEI:';
            parts[4] = Strings.toString(value);
            parts[5] = '</text><text x="10" y="950" class="base">STARTED AT:';
            parts[6] = Strings.toString(timestamp_start);
            parts[7] = '</text><text x="10" y="980" class="base">DURATION:';
            parts[8] = Strings.toString(duration);
            parts[9] = '</text><text x="10" y="1010" class="base">STATUS:';
            // TODO: Check if active is needed or not
            if (timestamp_start > 0) {
                parts[10] = "ACTIVE";
            } else if (canceled) {
                parts[10] = "CANCELED";
            } else {
                parts[10] = "N/A";
            }
            parts[11] = "</text></svg>";

            string memory svg = string(
                abi.encodePacked(
                    parts[0],
                    parts[1],
                    parts[2],
                    parts[3],
                    parts[4],
                    parts[5],
                    parts[6],
                    parts[7]
                )
            );
            svg = string(
                abi.encodePacked(
                    svg,
                    parts[8],
                    parts[9],
                    parts[10],
                    parts[11]
                )
            );

            string memory json = Base64.encode(
                bytes(
                    string(
                        abi.encodePacked(
                            '{"name": "DEAL #',
                            Strings.toString(deal_index),
                            '", "description": "Retriev deal token", "image": "data:image/svg+xml;base64,',
                            Base64.encode(bytes(svg)),
                            '"}'
                        )
                    )
                )
            );
            string memory output = string(
                abi.encodePacked("data:application/json;base64,", json)
            );
            return output;
        } else {
            return "";
        }
    }
}
